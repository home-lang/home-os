// home-os dmesg
// Display kernel ring buffer

import "../../kernel/src/core/foundation.home" as foundation

const DMESG_BUFFER_SIZE: u32 = 4096

var dmesg_buffer: [u8; 4096]
var dmesg_pos: u32 = 0

export fn dmesg_init() {
  dmesg_pos = 0
}

export fn dmesg_log(message: u64) {
  var i: u32 = 0
  while i < 256 {
    var ch: u8 = @intToPtr(message + i, u8)
    if ch == 0 { break }
    
    if dmesg_pos < DMESG_BUFFER_SIZE {
      dmesg_buffer[dmesg_pos] = ch
      dmesg_pos = dmesg_pos + 1
    }
    
    i = i + 1
  }
}

export fn dmesg_main() {
  foundation.vga_clear()
  foundation.vga_write_string("=== Kernel Messages ===\n\n")
  
  var i: u32 = 0
  while i < dmesg_pos {
    foundation.vga_write_char(dmesg_buffer[i])
    i = i + 1
  }
}
