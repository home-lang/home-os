// home-os Cp
// Copy files and directories

import "../../kernel/src/core/foundation.home" as foundation
import "../../kernel/src/core/filesystem.home" as filesystem

export fn cp_main(source: u64, dest: u64) {
  foundation.vga_write_string("Copying ")
  foundation.vga_write_string(source)
  foundation.vga_write_string(" to ")
  foundation.vga_write_string(dest)
  foundation.vga_write_string("\n")
  
  var fd_src: u32 = filesystem.vfs_open(source, 0)
  if fd_src == 0 {
    foundation.vga_write_string("cp: cannot open ")
    foundation.vga_write_string(source)
    foundation.vga_write_string("\n")
    return
  }
  
  var fd_dst: u32 = filesystem.vfs_open(dest, 1)
  if fd_dst == 0 {
    filesystem.vfs_close(fd_src)
    foundation.vga_write_string("cp: cannot create ")
    foundation.vga_write_string(dest)
    foundation.vga_write_string("\n")
    return
  }
  
  var buffer: [u8; 4096]
  var bytes: u64 = filesystem.vfs_read(fd_src, @ptrFromInt(buffer), 4096)
  filesystem.vfs_write(fd_dst, @ptrFromInt(buffer), bytes)
  
  filesystem.vfs_close(fd_src)
  filesystem.vfs_close(fd_dst)
  
  foundation.vga_write_string("Copy complete\n")
}
