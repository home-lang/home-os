// home-os Wc
// Word count

import "../../kernel/src/core/foundation.home" as foundation
import "../../kernel/src/core/filesystem.home" as filesystem

export fn wc_main(file: u64) {
  var fd: u32 = filesystem.vfs_open(file, 0)
  if fd == 0 {
    foundation.vga_write_string("wc: cannot open ")
    foundation.vga_write_string(file)
    foundation.vga_write_string("\n")
    return
  }
  
  var buffer: [u8; 4096]
  var bytes: u64 = filesystem.vfs_read(fd, @ptrFromInt(buffer), 4096)
  
  var lines: u32 = 0
  var words: u32 = 0
  var chars: u32 = bytes
  var in_word: u32 = 0
  
  var i: u32 = 0
  while i < bytes {
    if buffer[i] == '\n' {
      lines = lines + 1
    }
    
    if buffer[i] == ' ' or buffer[i] == '\n' or buffer[i] == '\t' {
      in_word = 0
    } else {
      if in_word == 0 {
        words = words + 1
        in_word = 1
      }
    }
    
    i = i + 1
  }
  
  filesystem.vfs_close(fd)
  
  foundation.vga_write_string("  ")
  foundation.vga_write_string("  ")
  foundation.vga_write_string("  ")
  foundation.vga_write_string(" ")
  foundation.vga_write_string(file)
  foundation.vga_write_string("\n")
}
