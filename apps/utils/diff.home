// home-os Diff
// Compare files

import "../../kernel/src/core/foundation.home" as foundation
import "../../kernel/src/core/filesystem.home" as filesystem

export fn diff_main(file1: u64, file2: u64) {
  var fd1: u32 = filesystem.vfs_open(file1, 0)
  var fd2: u32 = filesystem.vfs_open(file2, 0)
  
  if fd1 == 0 or fd2 == 0 {
    foundation.vga_write_string("diff: cannot open files\n")
    return
  }
  
  var buffer1: [u8; 4096]
  var buffer2: [u8; 4096]
  
  var bytes1: u64 = filesystem.vfs_read(fd1, @ptrFromInt(buffer1), 4096)
  var bytes2: u64 = filesystem.vfs_read(fd2, @ptrFromInt(buffer2), 4096)
  
  if bytes1 != bytes2 {
    foundation.vga_write_string("Files differ in size\n")
  } else {
    var differ: u32 = 0
    var i: u32 = 0
    while i < bytes1 {
      if buffer1[i] != buffer2[i] {
        differ = 1
        break
      }
      i = i + 1
    }
    
    if differ == 1 {
      foundation.vga_write_string("Files differ\n")
    } else {
      foundation.vga_write_string("Files are identical\n")
    }
  }
  
  filesystem.vfs_close(fd1)
  filesystem.vfs_close(fd2)
}
