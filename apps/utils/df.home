// home-os Disk Free
// Show disk space usage for mounted filesystems

import "../../kernel/src/core/foundation.home" as foundation
import "../../kernel/src/core/filesystem.home" as filesystem

// Format size in human-readable form (K, M, G, T)
fn format_size(bytes: u64, buf: *[u8; 16]) {
  var size: u64 = bytes
  var suffix: u8 = 'B'

  if size >= 1099511627776 {  // TB
    size = size / 1099511627776
    suffix = 'T'
  } else if size >= 1073741824 {  // GB
    size = size / 1073741824
    suffix = 'G'
  } else if size >= 1048576 {  // MB
    size = size / 1048576
    suffix = 'M'
  } else if size >= 1024 {  // KB
    size = size / 1024
    suffix = 'K'
  }

  // Convert to string
  var i: u32 = 0
  if size == 0 {
    buf[0] = '0'
    i = 1
  } else {
    var digits: [u8; 16]
    var d: u32 = 0
    var n: u64 = size
    while n > 0 {
      digits[d] = @intCast('0' + (n % 10))
      n = n / 10
      d = d + 1
    }
    // Reverse
    while d > 0 {
      d = d - 1
      buf[i] = digits[d]
      i = i + 1
    }
  }

  buf[i] = suffix
  i = i + 1
  buf[i] = 0
}

// Pad string to width
fn pad_string(s: *u8, width: u32) {
  var len: u32 = 0
  while s[len] != 0 { len = len + 1 }

  foundation.serial_write_string(s)
  var spaces: u32 = 0
  while spaces < width - len {
    foundation.serial_write_char(' ')
    spaces = spaces + 1
  }
}

export fn df_main() {
  foundation.serial_write_string("\n=== Disk Free (df) ===\n\n")
  foundation.serial_write_string("Filesystem      Size      Used     Avail  Use%  Mounted on\n")
  foundation.serial_write_string("----------------------------------------------------------\n")

  var mount_count: u32 = filesystem.vfs_get_mount_count()
  var i: u32 = 0

  while i < mount_count {
    var path: [u8; 64]
    var device: [u8; 32]
    var total: u64 = 0
    var free: u64 = 0
    var block_size: u32 = 0

    var result: u32 = filesystem.vfs_get_mount_info(i, &path, &device, &total, &free, &block_size)
    if result == 0 {
      var used: u64 = total - free
      var use_percent: u32 = 0
      if total > 0 {
        use_percent = @intCast((used * 100) / total)
      }

      // Format sizes
      var size_buf: [u8; 16]
      var used_buf: [u8; 16]
      var avail_buf: [u8; 16]

      format_size(total, &size_buf)
      format_size(used, &used_buf)
      format_size(free, &avail_buf)

      // Print device (padded to 16)
      pad_string(&device[0], 16)

      // Print size (padded to 10)
      pad_string(&size_buf[0], 10)

      // Print used (padded to 9)
      pad_string(&used_buf[0], 9)

      // Print available (padded to 7)
      pad_string(&avail_buf[0], 7)

      // Print use percentage
      if use_percent < 10 {
        foundation.serial_write_string("  ")
      } else if use_percent < 100 {
        foundation.serial_write_string(" ")
      }
      foundation.serial_write_u32(use_percent)
      foundation.serial_write_string("%  ")

      // Print mount point
      foundation.serial_write_string(&path[0])
      foundation.serial_write_string("\n")
    }

    i = i + 1
  }

  foundation.serial_write_string("\n")
}

// Main entry point for standalone execution
export fn main(): i32 {
  df_main()
  return 0
}
