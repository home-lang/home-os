// home-os Network Test
// Network diagnostics tool

import "../kernel/src/core/foundation.home" as foundation
import "../kernel/src/net/icmp.home" as icmp
import "../kernel/src/net/arp.home" as arp
import "../kernel/src/drivers/keyboard.home" as keyboard

fn nettest_display() {
  foundation.vga_clear()
  foundation.vga_write_string("=== Network Test ===\n\n")
  foundation.vga_write_string("1. Ping 10.0.0.1\n")
  foundation.vga_write_string("2. ARP Request\n")
  foundation.vga_write_string("3. Show ARP Cache\n")
  foundation.vga_write_string("Q. Quit\n\n")
  foundation.vga_write_string("Select option: ")
}

export fn nettest_main() {
  nettest_display()
  
  var running: u32 = 1
  while running == 1 {
    while keyboard.keyboard_has_char() == 0 {}
    var ch: u8 = keyboard.keyboard_getchar()
    
    if ch == 'q' or ch == 'Q' {
      running = 0
    } else if ch == '1' {
      foundation.vga_write_string("\nSending ping...\n")
      icmp.icmp_ping(0x0A000001)
      foundation.vga_write_string("Ping sent!\n")
    } else if ch == '2' {
      foundation.vga_write_string("\nSending ARP request...\n")
      arp.arp_request(0x0A000001)
      foundation.vga_write_string("ARP request sent!\n")
    } else if ch == '3' {
      foundation.vga_write_string("\nARP Cache:\n")
      foundation.vga_write_string("(Not implemented)\n")
    }
  }
}
