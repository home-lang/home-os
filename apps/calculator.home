// home-os Calculator
// Simple calculator app

import "../kernel/src/core/foundation.home" as foundation
import "../kernel/src/drivers/keyboard.home" as keyboard

var result: i64 = 0
var current: i64 = 0
var operation: u8 = 0

fn calc_display() {
  foundation.vga_clear()
  foundation.vga_write_string("=== Calculator ===\n\n")
  foundation.vga_write_string("Result: ")
  foundation.vga_write_string("\n\n")
  foundation.vga_write_string("Enter number and operation (+,-,*,/)\n")
  foundation.vga_write_string("Press = to calculate, Q to quit\n")
}

fn calc_process(ch: u8) {
  if ch >= '0' and ch <= '9' {
    current = current * 10 + (ch - '0')
  } else if ch == '+' or ch == '-' or ch == '*' or ch == '/' {
    if operation != 0 {
      // Perform previous operation
      if operation == '+' {
        result = result + current
      } else if operation == '-' {
        result = result - current
      } else if operation == '*' {
        result = result * current
      } else if operation == '/' and current != 0 {
        result = result / current
      }
    } else {
      result = current
    }
    current = 0
    operation = ch
  } else if ch == '=' {
    if operation == '+' {
      result = result + current
    } else if operation == '-' {
      result = result - current
    } else if operation == '*' {
      result = result * current
    } else if operation == '/' and current != 0 {
      result = result / current
    }
    current = result
    operation = 0
  } else if ch == 'c' or ch == 'C' {
    result = 0
    current = 0
    operation = 0
  }
}

export fn calculator_main() {
  calc_display()
  
  var running: u32 = 1
  while running == 1 {
    while keyboard.keyboard_has_char() == 0 {}
    var ch: u8 = keyboard.keyboard_getchar()
    
    if ch == 'q' or ch == 'Q' {
      running = 0
    } else {
      calc_process(ch)
      calc_display()
    }
  }
}
