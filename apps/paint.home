// home-os Paint Application
// Simple graphics drawing program

import "../kernel/src/core/foundation.home" as foundation
import "../kernel/src/drivers/vga_graphics.home" as vga
import "../kernel/src/drivers/mouse.home" as mouse
import "../kernel/src/drivers/keyboard.home" as keyboard

var current_color: u8 = 15
var drawing: u32 = 0

fn paint_init_palette() {
  vga.vga_set_palette(0, 0, 0, 0)        // Black
  vga.vga_set_palette(1, 255, 0, 0)      // Red
  vga.vga_set_palette(2, 0, 255, 0)      // Green
  vga.vga_set_palette(3, 0, 0, 255)      // Blue
  vga.vga_set_palette(4, 255, 255, 0)    // Yellow
  vga.vga_set_palette(5, 255, 0, 255)    // Magenta
  vga.vga_set_palette(6, 0, 255, 255)    // Cyan
  vga.vga_set_palette(7, 255, 255, 255)  // White
}

fn paint_draw_ui() {
  // Draw color palette at bottom
  var i: u32 = 0
  while i < 8 {
    vga.vga_draw_rect(i * 40, 180, 40, 20, i)
    i = i + 1
  }
}

export fn paint_main() {
  vga.vga_graphics_init()
  paint_init_palette()
  vga.vga_fill_screen(0)
  paint_draw_ui()
  
  var running: u32 = 1
  var last_x: i32 = 0
  var last_y: i32 = 0
  
  while running == 1 {
    var x: i32 = mouse.mouse_get_x()
    var y: i32 = mouse.mouse_get_y()
    var buttons: u8 = mouse.mouse_get_buttons()
    
    if (buttons & 0x01) != 0 {
      if y < 180 {
        vga.vga_put_pixel(x, y, current_color)
        if drawing == 1 {
          vga.vga_draw_line(last_x, last_y, x, y, current_color)
        }
        drawing = 1
      } else {
        current_color = x / 40
      }
    } else {
      drawing = 0
    }
    
    last_x = x
    last_y = y
    
    if keyboard.keyboard_has_char() == 1 {
      var ch: u8 = keyboard.keyboard_getchar()
      if ch == 'q' or ch == 'Q' {
        running = 0
      } else if ch == 'c' or ch == 'C' {
        vga.vga_fill_screen(0)
        paint_draw_ui()
      }
    }
  }
}
