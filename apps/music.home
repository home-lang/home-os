// home-os Music Player
// Simple audio player

import "../kernel/src/core/foundation.home" as foundation
import "../kernel/src/drivers/sound.home" as sound
import "../kernel/src/drivers/keyboard.home" as keyboard

var playing: u32 = 0
var current_track: u32 = 0

fn music_display() {
  foundation.vga_clear()
  foundation.vga_write_string("=== Music Player ===\n\n")
  
  if playing == 1 {
    foundation.vga_write_string("Status: Playing\n")
  } else {
    foundation.vga_write_string("Status: Stopped\n")
  }
  
  foundation.vga_write_string("Track: ")
  foundation.vga_write_string("\n\n")
  
  foundation.vga_write_string("Commands:\n")
  foundation.vga_write_string("  P - Play/Pause\n")
  foundation.vga_write_string("  S - Stop\n")
  foundation.vga_write_string("  N - Next track\n")
  foundation.vga_write_string("  + - Volume up\n")
  foundation.vga_write_string("  - - Volume down\n")
  foundation.vga_write_string("  Q - Quit\n")
}

export fn music_main() {
  sound.sound_init()
  music_display()
  
  var running: u32 = 1
  var volume: u8 = 128
  
  while running == 1 {
    while keyboard.keyboard_has_char() == 0 {}
    var ch: u8 = keyboard.keyboard_getchar()
    
    if ch == 'q' or ch == 'Q' {
      running = 0
    } else if ch == 'p' or ch == 'P' {
      if playing == 1 {
        sound.sound_stop(0)
        playing = 0
      } else {
        playing = 1
      }
      music_display()
    } else if ch == 's' or ch == 'S' {
      sound.sound_stop(0)
      playing = 0
      music_display()
    } else if ch == 'n' or ch == 'N' {
      current_track = current_track + 1
      music_display()
    } else if ch == '+' {
      if volume < 255 {
        volume = volume + 16
        sound.sound_set_volume(0, volume)
      }
    } else if ch == '-' {
      if volume > 0 {
        volume = volume - 16
        sound.sound_set_volume(0, volume)
      }
    }
  }
}
