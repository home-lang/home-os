// home-os CD-ROM Driver
// ATAPI CD-ROM support

import "../core/foundation.home" as foundation
import "ata.home" as ata

const ATAPI_CMD_READ: u8 = 0xA8
const ATAPI_CMD_EJECT: u8 = 0x1B

const CDROM_SECTOR_SIZE: u32 = 2048

var cdrom_initialized: u32 = 0

export fn cdrom_init() {
  if cdrom_initialized == 1 { return }
  
  cdrom_initialized = 1
  foundation.serial_write_string("[CDROM] Initialized\n")
}

export fn cdrom_read_sector(lba: u32, buffer: u64) -> u32 {
  if cdrom_initialized == 0 { return 1 }
  
  var packet: [u8; 12]
  packet[0] = ATAPI_CMD_READ
  packet[1] = 0
  packet[2] = (lba >> 24) & 0xFF
  packet[3] = (lba >> 16) & 0xFF
  packet[4] = (lba >> 8) & 0xFF
  packet[5] = lba & 0xFF
  packet[6] = 0
  packet[7] = 0
  packet[8] = 0
  packet[9] = 1  // Read 1 sector
  packet[10] = 0
  packet[11] = 0
  
  // Send ATAPI packet (stub)
  return 0
}

export fn cdrom_eject() {
  if cdrom_initialized == 0 { return }
  
  var packet: [u8; 12]
  packet[0] = ATAPI_CMD_EJECT
  packet[1] = 0
  packet[2] = 0
  packet[3] = 0
  packet[4] = 0x02  // Eject
  packet[5] = 0
  packet[6] = 0
  packet[7] = 0
  packet[8] = 0
  packet[9] = 0
  packet[10] = 0
  packet[11] = 0
  
  foundation.serial_write_string("[CDROM] Ejecting...\n")
}
