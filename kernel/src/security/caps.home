// home-os Capabilities
// Capability-based security

import "../core/foundation.home" as foundation
import "capabilities.home" as capabilities
import "audit.home" as audit

// Initialize the global capability engine.
export fn caps_init() {
  capabilities.capabilities_init()
  foundation.serial_write_string("[Caps] Capability system initialized\n")
}

// Check whether a given process has the specified capability bit set.
// Returns 1 on success (allowed), 0 on failure (denied).
export fn caps_check(process_id: u32, cap: u64): u32 {
  var has_cap: u32 = capabilities.cap_check_capability(process_id, cap)

  var result: i32 = 0
  if has_cap == 0 {
    result = -1
  }

  // UID is not yet tracked per-process in this kernel slice, so we pass 0.
  audit.audit_log_capability(process_id, 0, cap, result)
  return has_cap
}

// Grant one or more capabilities to a process by updating its permitted and
// effective sets, then log the change via the audit subsystem.
export fn caps_set(process_id: u32, caps: u64) {
  // Constrain requested capabilities by the process's bounding set.
  capabilities.cap_set_permitted(process_id, caps)
  // Make the permitted capabilities effective for this process.
  capabilities.cap_add_capability(process_id, caps)

  audit.audit_log_capability(process_id, 0, caps, 0)
}

// Drop a capability from a process's effective set and record the event.
export fn caps_drop(process_id: u32, cap: u64) {
  capabilities.cap_remove_capability(process_id, cap)
  audit.audit_log_capability(process_id, 0, cap, 0)
}

